# Midcurve Finance - Production Docker Compose
#
# This configuration runs the full stack:
# - Caddy (reverse proxy with auto SSL)
# - UI (Vite SPA served via nginx)
# - API (Next.js backend)
# - Onchain Data (Real-time pool price and position event subscriptions)
# - Business Logic (RabbitMQ consumer for close order event processing)
# - Automation (Close order execution)
# - Signer (Private signing service)
# - RabbitMQ (Message broker)
#
# Database: External PostgreSQL (AWS RDS recommended)
#
# Usage:
#   docker compose up -d              # Start all services
#   docker compose logs -f            # Follow logs
#   docker compose down               # Stop all services
#   docker compose exec api npx prisma migrate deploy  # Run migrations

services:
  # ============================================
  # REVERSE PROXY
  # ============================================
  caddy:
    image: caddy:2-alpine
    container_name: midcurve-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      ui:
        condition: service_started
      api:
        condition: service_started
    restart: unless-stopped
    networks:
      - frontend
      - backend

  # ============================================
  # FRONTEND
  # ============================================
  ui:
    build:
      context: .
      dockerfile: apps/midcurve-ui/Dockerfile
      args:
        - VITE_WALLETCONNECT_PROJECT_ID=${VITE_WALLETCONNECT_PROJECT_ID}
        - VITE_API_URL=${VITE_API_URL}
    container_name: midcurve-ui
    expose:
      - "3000"
    restart: unless-stopped
    networks:
      - frontend

  # ============================================
  # API SERVER
  # ============================================
  api:
    build:
      context: .
      dockerfile: apps/midcurve-api/Dockerfile
    container_name: midcurve-api
    expose:
      - "3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - HOSTNAME=0.0.0.0
      - DATABASE_URL=${DATABASE_URL}
      # CORS & Cookies
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN:-.midcurve.finance}
      # RPC URLs
      - RPC_URL_ETHEREUM=${RPC_URL_ETHEREUM}
      - RPC_URL_ARBITRUM=${RPC_URL_ARBITRUM}
      - RPC_URL_BASE=${RPC_URL_BASE}
      - RPC_URL_BSC=${RPC_URL_BSC}
      - RPC_URL_POLYGON=${RPC_URL_POLYGON}
      - RPC_URL_OPTIMISM=${RPC_URL_OPTIMISM}
      # Internal services
      - SIGNER_URL=http://signer:3003
      - SIGNER_INTERNAL_API_KEY=${SIGNER_INTERNAL_API_KEY}
      - AUTOMATION_URL=http://automation:3004
      # External APIs
      - COINGECKO_API_KEY=${COINGECKO_API_KEY:-}
      - ETHERSCAN_API_KEY=${ETHERSCAN_API_KEY:-}
      - THE_GRAPH_API_KEY=${THE_GRAPH_API_KEY:-}
    depends_on:
      signer:
        condition: service_started
      automation:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - frontend
      - backend
      - database

  # ============================================
  # ONCHAIN DATA SERVICE
  # - Real-time Swap event subscriptions via WebSocket
  # - Real-time position liquidity event subscriptions
  # - Publishes to RabbitMQ exchanges (pool-prices, position-liquidity-events)
  # ============================================
  onchain-data:
    build:
      context: .
      dockerfile: apps/midcurve-onchain-data/Dockerfile
    container_name: midcurve-onchain-data
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # RabbitMQ
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASS=${RABBITMQ_PASS}
      # WebSocket RPC URLs (for Swap event subscriptions)
      - WS_RPC_URL_ETHEREUM=${WS_RPC_URL_ETHEREUM:-}
      - WS_RPC_URL_ARBITRUM=${WS_RPC_URL_ARBITRUM:-}
      - WS_RPC_URL_BASE=${WS_RPC_URL_BASE:-}
      - WS_RPC_URL_BSC=${WS_RPC_URL_BSC:-}
      - WS_RPC_URL_POLYGON=${WS_RPC_URL_POLYGON:-}
      - WS_RPC_URL_OPTIMISM=${WS_RPC_URL_OPTIMISM:-}
      # Worker configuration (optional, has sensible defaults)
      - MAX_POOLS_PER_CONNECTION=${MAX_POOLS_PER_CONNECTION:-1000}
      - RECONNECT_DELAY_MS=${RECONNECT_DELAY_MS:-5000}
      - MAX_RECONNECT_ATTEMPTS=${MAX_RECONNECT_ATTEMPTS:-10}
      - POLL_INTERVAL_MS=${POLL_INTERVAL_MS:-5000}
      - CLEANUP_INTERVAL_MS=${CLEANUP_INTERVAL_MS:-60000}
      - STALE_THRESHOLD_MS=${STALE_THRESHOLD_MS:-60000}
      - PRUNE_THRESHOLD_MS=${PRUNE_THRESHOLD_MS:-86400000}
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - backend
      - database

  # ============================================
  # AUTOMATION SERVICE
  # - Contract bytecode serving (compiled Solidity contracts)
  # - Close order execution (consumes from onchain-data via RabbitMQ)
  # ============================================
  automation:
    build:
      context: .
      dockerfile: apps/midcurve-automation/Dockerfile
    container_name: midcurve-automation
    expose:
      - "3004"
    environment:
      - NODE_ENV=production
      - PORT=3004
      - HOSTNAME=0.0.0.0
      - DATABASE_URL=${DATABASE_URL}
      # RabbitMQ
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASS=${RABBITMQ_PASS}
      # RPC URLs (for reading pool prices, position data)
      - RPC_URL_ETHEREUM=${RPC_URL_ETHEREUM}
      - RPC_URL_ARBITRUM=${RPC_URL_ARBITRUM}
      - RPC_URL_BASE=${RPC_URL_BASE}
      - RPC_URL_BSC=${RPC_URL_BSC}
      - RPC_URL_POLYGON=${RPC_URL_POLYGON}
      - RPC_URL_OPTIMISM=${RPC_URL_OPTIMISM}
      # External APIs (for position ledger sync)
      - ETHERSCAN_API_KEY=${ETHERSCAN_API_KEY:-}
      # Signer service (for tx signing)
      - SIGNER_URL=http://signer:3003
      - SIGNER_INTERNAL_API_KEY=${SIGNER_INTERNAL_API_KEY}
      # Worker configuration
      - DEPLOY_POLL_INTERVAL_MS=${DEPLOY_POLL_INTERVAL_MS:-5000}
      - ORDER_EXECUTOR_POOL_SIZE=${ORDER_EXECUTOR_POOL_SIZE:-3}
      # Fee configuration
      - EXECUTION_FEE_RECIPIENT=${EXECUTION_FEE_RECIPIENT:-}
      - EXECUTION_FEE_BPS=${EXECUTION_FEE_BPS:-50}
    depends_on:
      rabbitmq:
        condition: service_healthy
      onchain-data:
        condition: service_started
      signer:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3004/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - backend
      - database

  # ============================================
  # BUSINESS LOGIC SERVICE
  # - Consumes close order lifecycle events from RabbitMQ
  # - Synchronizes on-chain state with database
  # ============================================
  business-logic:
    build:
      context: .
      dockerfile: apps/midcurve-business-logic/Dockerfile
    container_name: midcurve-business-logic
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # RabbitMQ
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASS=${RABBITMQ_PASS}
    depends_on:
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - backend
      - database

  # ============================================
  # MESSAGE BROKER
  # ============================================
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: midcurve-rabbitmq
    expose:
      - "5672"
      - "15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-midcurve}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS}
      RABBITMQ_DEFAULT_VHOST: /
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "check_port_connectivity"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped
    networks:
      - backend

  # ============================================
  # SIGNING SERVICE (INTERNAL ONLY)
  # ============================================
  # Note: Signer has NO external RPC access for security.
  # Gas estimation is done by the caller (automation service).
  signer:
    build:
      context: .
      dockerfile: apps/midcurve-signer/Dockerfile
    container_name: midcurve-signer
    expose:
      - "3003"
    environment:
      - NODE_ENV=production
      - PORT=3003
      - HOSTNAME=0.0.0.0
      - DATABASE_URL=${DATABASE_URL}
      - SIGNER_INTERNAL_API_KEY=${SIGNER_INTERNAL_API_KEY}
      - SIGNER_USE_LOCAL_KEYS=${SIGNER_USE_LOCAL_KEYS:-true}
      - SIGNER_LOCAL_ENCRYPTION_KEY=${SIGNER_LOCAL_ENCRYPTION_KEY}
    restart: unless-stopped
    networks:
      - backend
      - database

# ============================================
# NETWORKS
# ============================================
networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    internal: true  # No external access - keeps geth, rabbitmq isolated
  database:
    driver: bridge
    # External access allowed for AWS RDS connectivity
    # Only services that need database access should join this network

# ============================================
# VOLUMES
# ============================================
volumes:
  caddy-data:
    driver: local
  caddy-config:
    driver: local
  rabbitmq-data:
    driver: local
