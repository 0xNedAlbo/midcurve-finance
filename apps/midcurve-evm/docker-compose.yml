# SEMSEE Embedded EVM - Development Configuration
#
# Uses Geth in --dev mode with persistent state.
# Contracts are deployed dynamically on first startup.
#
# Startup flow:
# 1. geth: Starts Geth node in dev mode (pre-funded dev account)
# 2. fund-core: Transfers ETH from dev account to CORE account
# 3. deploy-stores: Deploys SystemRegistry and Store contracts

services:
  geth:
    build:
      context: .
      dockerfile: Dockerfile.geth
    container_name: midcurve-geth
    ports:
      - "8545:8545"
      - "8546:8546"
    volumes:
      - geth-data:/data  # Persistent state
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  fund-core:
    build:
      context: .
      dockerfile: Dockerfile.foundry
    container_name: midcurve-fund-core
    depends_on:
      geth:
        condition: service_healthy
    environment:
      - CORE_ADDRESS=${CORE_ADDRESS:-0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266}
      - RPC_URL=http://geth:8545
    command: /app/scripts/fund-core.sh
    restart: "no"

  deploy-stores:
    build:
      context: .
      dockerfile: Dockerfile.foundry
    container_name: midcurve-deploy-stores
    depends_on:
      fund-core:
        condition: service_completed_successfully
    working_dir: /app/contracts
    environment:
      - CORE_PRIVATE_KEY=${CORE_PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}
    # Deploy SystemRegistry and Store contracts
    # Uses CORE_PRIVATE_KEY from environment (defaults to Foundry account 0)
    command: >
      sh -c "forge script script/DeployStores.s.sol
      --rpc-url http://geth:8545
      --private-key $$CORE_PRIVATE_KEY
      --broadcast
      -vvvv"
    restart: "no"

volumes:
  geth-data:
